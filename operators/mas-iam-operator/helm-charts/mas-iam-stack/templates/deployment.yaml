{{- $routeHost := (include "mas-iam-stack.routeHost" .) | trim }}
{{- $bootstrap := .Values.keycloak.bootstrapAdmin -}}
{{- $bootstrapSecretName := (include "mas-iam-stack.bootstrapAdminSecretName" .) | trim }}
{{- $ldapCfg := .Values.keycloak.ldap -}}
{{- $ldapTls := $ldapCfg.tls | default dict -}}
{{- $ldapTlsEnabled := and $ldapCfg.tls $ldapCfg.tls.enabled -}}
{{- $ldapTlsFile := default "ldap-truststore.p12" $ldapTls.truststoreFile -}}
{{- $ldapTruststorePassword := default "changeit" $ldapCfg.truststorePassword -}}
{{- $ldapTruststorePasswordSecret := default "" $ldapCfg.truststorePasswordSecret -}}
{{- $ldapTruststorePasswordKey := default "password" $ldapCfg.truststorePasswordKey -}}
{{- $ldapTlsPassword := default $ldapTruststorePassword $ldapTls.truststorePassword -}}
{{- $ldapTlsPasswordSecret := default $ldapTruststorePasswordSecret $ldapTls.truststorePasswordSecret -}}
{{- $ldapTlsPasswordKey := default $ldapTruststorePasswordKey $ldapTls.truststorePasswordKey -}}
{{- $ldapTlsSecret := default (printf "%s-keycloak-openldap-tls" (include "mas-iam-stack.fullname" .)) $ldapTls.caSecret -}}
{{- $ldapTlsCaKey := default "ca.crt" $ldapTls.caBundleKey -}}
{{- $ldapTlsHostnamePolicy := default "ANY" $ldapTls.hostnameVerificationPolicy -}}
{{- $pgSecretName := .Values.postgresql.auth.existingSecret | default (printf "%s-postgresql" .Release.Name) -}}
{{- $keycloakServiceAccount := include "mas-iam-stack.keycloakServiceAccountName" . | trim -}}
{{- if not $bootstrapSecretName -}}
  {{- fail "Set keycloak.bootstrapAdmin.secretName or enable keycloak.bootstrapAdmin.createSecret before deployment" -}}
{{- end -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mas-iam-stack.fullname" . }}
  labels:
    {{- include "mas-iam-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: keycloak
spec:
  replicas: {{ .Values.keycloak.replicaCount }}
  selector:
    matchLabels:
      {{- include "mas-iam-stack.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "mas-iam-stack.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: keycloak
    spec:
      serviceAccountName: {{ $keycloakServiceAccount }}
      {{- $hasBootstrapSecret := ne $bootstrapSecretName "" }}
      {{- $hasBootstrapInline := and $bootstrap.username $bootstrap.password }}
      {{- if or $hasBootstrapSecret $hasBootstrapInline $ldapTlsEnabled }}
      initContainers:
        {{- if or $hasBootstrapSecret $hasBootstrapInline }}
        - name: bootstrap-admin-password
          image: "{{ .Values.keycloak.image.registry }}/{{ .Values.keycloak.image.repository }}:{{ .Values.keycloak.image.tag }}"
          imagePullPolicy: {{ .Values.keycloak.image.pullPolicy }}
          command:
            - /bin/bash
            - -ec
            - |
              set -euo pipefail
              if [[ -z "${KC_BOOTSTRAP_ADMIN_PASSWORD:-}" ]]; then
                echo "Bootstrap admin password not provided; skipping bootstrap-admin invocation."
                exit 0
              fi
              echo "Ensuring bootstrap admin credentials are provisioned."
              set +e
              output=$(/opt/keycloak/bin/kc.sh bootstrap-admin user \
                --no-prompt=true \
                --username "${KC_BOOTSTRAP_ADMIN_USERNAME:-admin}" \
                --password:env KC_BOOTSTRAP_ADMIN_PASSWORD \
                --verbose 2>&1)
              rc=$?
              set -e
              if [[ "${rc}" -ne 0 ]]; then
                printf '%s\n' "${output}"
                if printf '%s\n' "${output}" | grep -qi "user with username exists"; then
                  echo "Bootstrap admin user already present; continuing."
                else
                  exit "${rc}"
                fi
              else
                printf '%s\n' "${output}"
              fi
              echo "Bootstrap admin credentials ready for use."
          env:
            - name: KC_BOOTSTRAP_ADMIN_REALM
              value: {{ default "master" .Values.keycloak.realmImport.realm | default "master" | quote }}
          {{- if $hasBootstrapSecret }}
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ $bootstrapSecretName | quote }}
                  key: {{ default "username" $bootstrap.usernameKey | quote }}
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $bootstrapSecretName | quote }}
                  key: {{ default "password" $bootstrap.passwordKey | quote }}
          {{- else }}
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              value: {{ $bootstrap.username | quote }}
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              value: {{ $bootstrap.password | quote }}
          {{- end }}
            - name: KC_DB
              value: postgres
            - name: KC_DB_USERNAME
              value: {{ .Values.postgresql.auth.username | quote }}
            - name: KC_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $pgSecretName | quote }}
                  key: {{ default "password" .Values.postgresql.auth.secretKeys.userPasswordKey | quote }}
            - name: KC_DB_URL_HOST
              value: {{ printf "%s-postgresql" .Release.Name | quote }}
            - name: KC_DB_URL_PORT
              value: "5432"
            - name: KC_DB_URL_DATABASE
              value: {{ .Values.postgresql.auth.database | quote }}
            - name: KC_DB_URL
              value: {{ printf "jdbc:postgresql://%s-postgresql:5432/%s" .Release.Name .Values.postgresql.auth.database | quote }}
        {{- end }}
        {{- if $ldapTlsEnabled }}
        - name: ldap-truststore-setup
          image: "{{ .Values.keycloak.image.registry }}/{{ .Values.keycloak.image.repository }}:{{ .Values.keycloak.image.tag }}"
          imagePullPolicy: {{ .Values.keycloak.image.pullPolicy }}
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            runAsNonRoot: false
            allowPrivilegeEscalation: false
          env:
            {{- if $ldapTlsPasswordSecret }}
            - name: TRUSTSTORE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $ldapTlsPasswordSecret | quote }}
                  key: {{ $ldapTlsPasswordKey | quote }}
            {{- else }}
            - name: TRUSTSTORE_PASSWORD
              value: {{ $ldapTlsPassword | quote }}
            {{- end }}
          command:
            - /bin/bash
            - -ec
            - |
              set -euo pipefail
              install -d -m 0750 /truststore
              if [[ ! -s /ldap-ca/{{ $ldapTlsCaKey }} ]]; then
                echo "Waiting for LDAP TLS CA bundle /ldap-ca/{{ $ldapTlsCaKey }} to be populated..."
              fi
              for attempt in $(seq 1 12); do
                if [[ -s /ldap-ca/{{ $ldapTlsCaKey }} ]]; then
                  break
                fi
                echo "Attempt ${attempt}/12: CA bundle still missing; sleeping 5s."
                sleep 5
              done
              if [[ ! -s /ldap-ca/{{ $ldapTlsCaKey }} ]]; then
                echo "LDAP TLS CA bundle /ldap-ca/{{ $ldapTlsCaKey }} not present after waiting; giving up." >&2
                exit 1
              fi
              rm -f /truststore/{{ $ldapTlsFile }}
              keytool -importcert -noprompt \
                -storetype PKCS12 \
                -keystore /truststore/{{ $ldapTlsFile }} \
                -storepass "${TRUSTSTORE_PASSWORD}" \
                -alias ldap-ca \
                -file /ldap-ca/{{ $ldapTlsCaKey }}
              chmod 0640 /truststore/{{ $ldapTlsFile }}
          volumeMounts:
            - name: ldap-truststore
              mountPath: /truststore
            - name: ldap-ca-bundle
              mountPath: /ldap-ca
        {{- end }}
      {{- end }}
      containers:
        - name: keycloak
          image: "{{ .Values.keycloak.image.registry }}/{{ .Values.keycloak.image.repository }}:{{ .Values.keycloak.image.tag }}"
          imagePullPolicy: {{ .Values.keycloak.image.pullPolicy }}
          args:
            {{- range $arg := .Values.keycloak.args }}
            - {{ $arg }}
            {{- end }}
            {{- if and .Values.keycloak.realmImport.enabled .Values.keycloak.realmImport.files }}
            - --import-realm
            {{- end }}
          env:
            {{- range $env := .Values.keycloak.env }}
            - name: {{ $env.name }}
              value: {{ $env.value | quote }}
            {{- end }}
            {{- if $bootstrapSecretName }}
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ $bootstrapSecretName | quote }}
                  key: {{ default "username" $bootstrap.usernameKey | quote }}
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $bootstrapSecretName | quote }}
                  key: {{ default "password" $bootstrap.passwordKey | quote }}
            {{- else if and $bootstrap.username $bootstrap.password }}
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              value: {{ $bootstrap.username | quote }}
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              value: {{ $bootstrap.password | quote }}
            {{- end }}
            - name: KC_DB
              value: postgres
            - name: KC_DB_USERNAME
              value: {{ .Values.postgresql.auth.username | quote }}
            - name: KC_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $pgSecretName | quote }}
                  key: {{ default "password" .Values.postgresql.auth.secretKeys.userPasswordKey | quote }}
            - name: KC_DB_URL_HOST
              value: {{ printf "%s-postgresql" .Release.Name | quote }}
            - name: KC_DB_URL_PORT
              value: "5432"
            - name: KC_DB_URL_DATABASE
              value: {{ .Values.postgresql.auth.database | quote }}
            - name: KC_DB_URL
              value: {{ printf "jdbc:postgresql://%s-postgresql:5432/%s" .Release.Name .Values.postgresql.auth.database | quote }}
            {{- if $routeHost }}
            - name: KC_HOSTNAME
              value: {{ $routeHost | quote }}
            - name: KC_HOSTNAME_URL
              value: {{ printf "https://%s" $routeHost | quote }}
            {{- end }}
            {{- if $ldapTlsEnabled }}
            - name: KC_SPI_TRUSTSTORE_FILE_FILE
              value: {{ printf "/opt/keycloak/conf/truststore/%s" $ldapTlsFile | quote }}
            - name: KC_SPI_TRUSTSTORE_FILE_PASSWORD
              {{- if $ldapTlsPasswordSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ $ldapTlsPasswordSecret | quote }}
                  key: {{ $ldapTlsPasswordKey | quote }}
              {{- else }}
              value: {{ $ldapTlsPassword | quote }}
              {{- end }}
            - name: KC_SPI_TRUSTSTORE_FILE_HOSTNAME_VERIFICATION_POLICY
              value: {{ $ldapTlsHostnamePolicy | quote }}
            - name: KC_SPI_TRUSTSTORE_FILE_TYPE
              value: PKCS12
            {{- end }}
            {{- if and .Values.keycloak.realmImport.enabled .Values.keycloak.realmImport.overrideExisting }}
            - name: KC_IMPORT_STRATEGY
              value: OVERWRITE_EXISTING
            {{- end }}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: management
              containerPort: 9000
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 9000
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /health/live
              port: 9000
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          volumeMounts:
            - name: curl-shim
              mountPath: /usr/local/bin/curl
              subPath: curl
              readOnly: true
            {{- if and .Values.keycloak.realmImport.enabled .Values.keycloak.realmImport.files }}
            - name: realm-import
              mountPath: /opt/keycloak/data/import
              readOnly: true
            {{- end }}
            {{- if $ldapTlsEnabled }}
            - name: ldap-truststore
              mountPath: /opt/keycloak/conf/truststore
            {{- end }}
      volumes:
        - name: curl-shim
          configMap:
            name: {{ include "mas-iam-stack.fullname" . }}-curl-shim
            defaultMode: 0555
        {{- if and .Values.keycloak.realmImport.enabled .Values.keycloak.realmImport.files }}
        - name: realm-import
          configMap:
            name: {{ include "mas-iam-stack.fullname" . }}-realm-import
        {{- end }}
        {{- if $ldapTlsEnabled }}
        - name: ldap-truststore
          emptyDir: {}
        - name: ldap-ca-bundle
          secret:
            secretName: {{ $ldapTlsSecret | quote }}
            items:
              - key: {{ $ldapTlsCaKey | quote }}
                path: {{ $ldapTlsCaKey | quote }}
            defaultMode: 0444
        {{- end }}
