# Apply this manifest to install the MAS IAM Operator via OLM.
# Replace every occurrence of `iam` if you want to target a different namespace.
# Development environments: this manifest now bootstraps LDAP TLS material automatically.
# The job below recreates <release>-openldap-tls with self-signed certificates.
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: masiamstacks.iam.mas.ibm.com
spec:
  group: iam.mas.ibm.com
  names:
    kind: MasIamStack
    listKind: MasIamStackList
    plural: masiamstacks
    singular: masiamstack
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: MasIamStack is the Schema for the masiamstacks API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: Spec defines the desired state of MasIamStack
            type: object
            x-kubernetes-preserve-unknown-fields: true
          status:
            description: Status defines the observed state of MasIamStack
            type: object
            x-kubernetes-preserve-unknown-fields: true
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mas-iam-sample-openldap-tls-generator
  namespace: iam
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: mas-iam-sample-openldap-tls-generator
  namespace: iam
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: mas-iam-sample-openldap-tls-generator
  namespace: iam
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: mas-iam-sample-openldap-tls-generator
subjects:
- kind: ServiceAccount
  name: mas-iam-sample-openldap-tls-generator
  namespace: iam
---
apiVersion: batch/v1
kind: Job
metadata:
  name: mas-iam-sample-generate-openldap-tls
  namespace: iam
  labels:
    app.kubernetes.io/component: openldap
    app.kubernetes.io/instance: mas-iam-sample
    app.kubernetes.io/name: keycloak
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/component: openldap
        app.kubernetes.io/instance: mas-iam-sample
        app.kubernetes.io/name: keycloak
    spec:
      restartPolicy: OnFailure
      serviceAccountName: mas-iam-sample-openldap-tls-generator
      containers:
      - name: generate
        image: quay.io/openshift/origin-cli:4.16
        imagePullPolicy: IfNotPresent
        env:
        - name: OPENLDAP_RELEASE
          value: mas-iam-sample
        - name: LDAP_TRUSTSTORE_PASSWORD
          value: ""
        command:
        - /bin/bash
        - -ec
        - |
          set -euo pipefail

          if ! command -v openssl >/dev/null 2>&1; then
            if command -v microdnf >/dev/null 2>&1; then
              microdnf install -y openssl >/dev/null 2>&1
            else
              echo "openssl is required but not available" >&2
              exit 1
            fi
          fi

          if command -v kubectl >/dev/null 2>&1; then
            kubectl_bin=kubectl
          elif command -v oc >/dev/null 2>&1; then
            kubectl_bin=oc
          else
            echo "kubectl (or oc) is required but not available" >&2
            exit 1
          fi

          namespace="${TARGET_NAMESPACE:-$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)}"
          release="${OPENLDAP_RELEASE:-mas-iam-sample}"
          truststore_password="${LDAP_TRUSTSTORE_PASSWORD:-}"
          if [[ -z "${truststore_password}" || "${truststore_password}" == "random" ]]; then
            while true; do
              truststore_password="$(head -c 32 /dev/urandom | LC_ALL=C tr -dc 'A-Za-z0-9')"
              if [[ ${#truststore_password} -ge 12 ]]; then
                break
              fi
            done
          fi

          service_host="${release}-openldap"
          svc_fqdn="${service_host}.${namespace}.svc"
          svc_cluster_fqdn="${svc_fqdn}.cluster.local"
          secret="${release}-openldap-tls"

          workdir="$(mktemp -d)"
          cleanup() {
            rm -rf "${workdir}"
          }
          trap cleanup EXIT
          pushd "${workdir}" >/dev/null

          openssl genrsa -out ca.key 4096
          openssl req -x509 -new -key ca.key -sha256 -days 3650 \
            -out ca.crt \
            -subj "/CN=${release} OpenLDAP Dev CA"

          openssl genrsa -out server.key 4096
          openssl req -new -key server.key -out server.csr \
            -subj "/CN=${svc_fqdn}"

          cat > server.ext <<EOF
          subjectAltName=DNS:${service_host},DNS:${svc_fqdn},DNS:${svc_cluster_fqdn}
          EOF

          openssl x509 -req -in server.csr \
            -CA ca.crt -CAkey ca.key -CAcreateserial \
            -out server.crt -days 730 -sha256 \
            -extfile server.ext

          openssl pkcs12 -export \
            -in ca.crt \
            -nokeys \
            -out ldap-truststore.p12 \
            -passout pass:"${truststore_password}"

          api_server="https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}"
          token="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
          cacert="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          kubectl_args=(--server "${api_server}" --token "${token}" --certificate-authority "${cacert}" --namespace "${namespace}")

          "${kubectl_bin}" "${kubectl_args[@]}" delete secret "${secret}" --ignore-not-found
          "${kubectl_bin}" "${kubectl_args[@]}" create secret generic "${secret}" \
            --from-file=ca.crt=ca.crt \
            --from-file=tls.crt=server.crt \
            --from-file=tls.key=server.key \
            --from-file=ldap-truststore.p12=ldap-truststore.p12 \
            --from-literal=truststorePassword="${truststore_password}" \
            --dry-run=client -o yaml | "${kubectl_bin}" "${kubectl_args[@]}" apply -f -

          "${kubectl_bin}" "${kubectl_args[@]}" label secret "${secret}" \
            app.kubernetes.io/name="${release}" \
            app.kubernetes.io/component=openldap \
            --overwrite

          "${kubectl_bin}" "${kubectl_args[@]}" annotate secret "${secret}" \
            mas.ibm.com/generated-by=mas-iam-dev \
            mas.ibm.com/description="Self-signed TLS material for the Keycloak/OpenLDAP integration (development use only)." \
            --overwrite

          echo "Generated ${secret} in namespace ${namespace}."
          echo "Truststore password: ${truststore_password}"
---
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: mas-iam-operator
  namespace: openshift-marketplace
spec:
  displayName: MAS IAM Operator
  image: quay.io/lee_forster/mas-iam-operator:catalog-0.0.8
  sourceType: grpc
---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: iam-operator-group
  namespace: iam
spec:
  targetNamespaces:
  - iam
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: mas-iam-operator
  namespace: iam
spec:
  channel: alpha
  installPlanApproval: Automatic
  name: mas-iam-operator
  source: mas-iam-operator
  sourceNamespace: openshift-marketplace
---
# Optional: example MasIamStack custom resource once the operator CSV is ready.
# Ensure the required LDAP TLS secret exists (see documentation) before applying.
apiVersion: iam.mas.ibm.com/v1alpha1
kind: MasIamStack
metadata:
  name: mas-iam-sample
  namespace: iam
spec:
  keycloak:
    ldap:
      autoConfigure: true
      autoConfigureOnUpgrade: false
      # Populate with the name of the secret containing LDAP bind credentials.
      bindCredentialSecret: ""
      # Provide the ldaps:// endpoint for your LDAP server.
      connectionUrl: "ldaps://mas-iam-sample-openldap.iam.svc.cluster.local:636"
      tls:
        enabled: true
        caSecret: mas-iam-sample-openldap-tls
        truststorePasswordSecret: mas-iam-sample-openldap-tls
        truststorePasswordKey: truststorePassword
  openldap:
    enabled: true
    userPasswords:
      createSecret: true
      data:
        sysadmin: sysadmin
        jane.doe: Passw0rd!
        joe.bloggs: Passw0rd!
        alex.manager: Passw0rd!
  postgresql:
    auth:
      password: keycloak123
      postgresPassword: admin123
    global:
      postgresql:
        auth:
          password: keycloak123
          postgresPassword: admin123
    primary:
      persistence:
        storageClass: rook-ceph-block
